{% extends "_layout.html" %}
{% block title %}Connect4{% endblock %}
{% block main_content %}

<h1>Connect4 Match {{match.id}}</h1>

{# Subscribe to updates #}
<div hx-ext="sse" sse-connect="/matches/{{match.id}}/changes/">
    <div class="grid" id="match_state" hx-get="/matches/{{match.id}}/" hx-trigger="sse:message">
        {% block match_state %}
        <div>
            {% if match.winner is not none %}
            {% if match.winner == 1 %}
            <h2>You won!</h2>
            {% elif match.winner == 2 %}
            <h2>You lost!</h2>
            {% else %}
            <h2>It's a tie!</h2>
            {% endif %}
            {% elif match.next_player == 1%}
            <h2>Your turn</h2>
            {% else %}
            <h2>Waiting for opponent's turn</h2>
            {% endif %}

            {# Build the board with svg. code based on https://codepen.io/rossta/pen/eyrgJe #}
            <svg width="350px" viewBox="0 0 700 700" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <pattern id="cell-pattern" patternUnits="userSpaceOnUse" width="100" height="100">
                        <circle cx="50" cy="50" r="45" fill="black"></circle>
                    </pattern>
                    <mask id="cell-mask">
                        <rect width="100" height="600" fill="white"></rect>
                        <rect width="100" height="600" fill="url(#cell-pattern)"></rect>
                    </mask>
                </defs>
                {% if match.winner is none and match.next_player == 1%}
                <svg x="0" y="0">
                    {% for i in range(0, 8): %}
                    <g>
                        <circle class="turn-marker" cx="{{ i*100 + 50 }}" cy="50" r="45"
                            hx-post="/matches/{{match.id}}/turns/" hx-target="#match_state"
                            hx-vals='{"player": 1, "column": {{i}}}'>
                        </circle>
                    </g>
                    {% endfor %}
                </svg>
                {% endif %}
                {% for col in range(0,7) %}
                <svg x="{{100 * col}}" y="100">
                    {% for row in range(0,6) %}
                    {% if match.state[col][row] == 1 %}
                    <circle cx="50" cy="{{ 550 - row * 100 }}" r="45" fill="#254689"></circle>
                    {% elif match.state[col][row] == 2 %}
                    <circle cx="50" cy="{{550-row*100}}" r="45" fill="#FC7E69"></circle>
                    {% endif %}
                    {% endfor %}
                    <rect width="100" height="600" fill="cadetblue" mask="url(#cell-mask)"></rect>
                </svg>
                {% endfor %}
            </svg>
        </div>
        <div>
            <h2>turns</h2>
            <div id="turns">
                {% block turns %}
                <ul>
                    {% for turn in match.turns %}
                    {% if turn.player == 1 %}
                    <li>You: {{turn.column}}</li>
                    {% else %}
                    <li>AI: {{turn.column}}</li>
                    {% endif %}
                    {% endfor %}
                </ul>
                {% endblock %}
            </div>
        </div>
        {% endblock %}
    </div>
</div>

{% endblock %}